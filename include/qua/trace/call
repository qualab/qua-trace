#pragma once

#include <qua/trace/export>
#include <memory>

namespace qua
{
    namespace trace
    {
        class qua_trace_public call
        {
        public:
            call(const char* name, const char* file, long long line);
            ~call();

            const char* get_name() const;
            const char* get_file() const;
            long long get_line() const;
            
            class stack;
            class warden;

        private:
            class data;

            std::shared_ptr<data> m_data;
        };

        class qua_trace_public call::stack
        {
        public:
            static const call& get_call(size_t offset = 0);
            static call::warden push(const call& new_call);

        private:
            // static methods only
            stack();
            stack(stack&&);
            stack(const stack&);
        };

        class qua_trace_public call::warden
        {
        public:
            warden();
            warden(warden&& temporary);
            ~warden();

        private:
            bool m_pop;

            // not allowed to copy
            warden(const warden&);
        };
    }
}

#define QUA_TRACE_CALL  \
    ::qua::trace::call::warden _call_warden = \
        ::qua::trace::call::stack::push( \
            ::qua::trace::call(__func__, __FILE__, __LINE__))
